---
theme: "default"
colorSchema: "light"
title: "AWSハンズオン: ALB + ECS + RDS構成"
info: |
  マネジメントコンソールで構築するWebアプリケーション基盤
fonts:
  sans: "M PLUS Rounded 1c"
  mono: "Fira Code"
---

## クラウドでTodo管理！ECS × RDS ハンズオン

マネジメントコンソールで構築するWebアプリケーション基盤

---

# 本日のアジェンダ

1.  **はじめに** - ゴールと構成の確認
2.  **全体構成図** - 作成するアーキテクチャ
3.  **ハンズオン手順**
    1. ネットワーク (VPC)
    2. セキュリティグループ
    3. データベース (RDS)
    4. コンテナリポジトリ (ECR)
    5. 踏み台サーバー (EC2)
    6. コンテナ実行環境 (ECS)
4.  **動作確認**
5.  **クリーンアップ**

---

# 1. ネットワーク構築 (VPC)

VPCダッシュボードから「VPCを作成」を選択し、「VPCなど」のウィザードで作成します。

- **名前タグ**: `handson-vpc`
- **AZの数**: `1`
- **パブリックサブネットの数**: `1`
- **プライベートサブネットの数**: `1`
- **NATゲートウェイ**: `1つのAZで`
- **VPCエンドポイント**: なし

<br>
<p class="text-sm">
これにより、VPC、サブネット、ルートテーブル、IGW、NAT GWが自動で作成されます。
</p>

---

# 2. セキュリティグループの作成 (1/2)

VPCダッシュボードで、以下のセキュリティグループを4つ作成します。

<br>

**① ALB用 (`handson-alb-sg`)**

- **インバウンドルール**:
  - `HTTP` (80), ソース: `Anywhere-IPv4` (0.0.0.0/0)

<br>

**② ECS用 (`handson-ecs-sg`)**

- **インバウンドルール**:
  - `カスタムTCP` (8080), ソース: `handson-alb-sg`

---

# 2. セキュリティグループの作成 (2/2)

**③ RDS用 (`handson-rds-sg`)**

- **インバウンドルール**:
  - `MYSQL/Aurora` (3306), ソース: `handson-ecs-sg`
  - `MYSQL/Aurora` (3306), ソース: `handson-bastion-sg`

<br>

**④ 踏み台サーバー用 (`handson-bastion-sg`)**

- **インバウンドルール**:
  - `SSH` (22), ソース: `マイIP`

<br>
<p class="text-sm">
<b>Note:</b> 相互参照するため、`handson-rds-sg`は一度ECSのルールのみで作成し、`handson-bastion-sg`作成後に再度編集して踏み台からのルールを追加します。
</p>

---

# 3. データベースの構築 (RDS)

RDSダッシュボードから「データベースの作成」を行います。

- **エンジン**: `MySQL`
- **テンプレート**: `開発/テスト`
- **DBインスタンス識別子**: `handson-db`
- **マスターユーザー名/パスワード**: `admin` / 任意
- **インスタンスクラス**: `db.t3.micro` (安価なもの)
- **VPC**: `handson-vpc`
- **サブネット**: プライベートサブネットを選択
- **パブリックアクセス**: `なし`
- **セキュリティグループ**: `handson-rds-sg`

---

# 4. コンテナリポジトリ (ECR)

ECRダッシュボードからリポジトリを作成し、Dockerイメージをプッシュします。

1.  **リポジトリ作成**
    - **可視性**: `プライベート`
    - **リポジトリ名**: `handson-app`
2.  **プッシュコマンドの表示**
    - 作成したリポジトリを選択し、「プッシュコマンドの表示」をクリック。
    - 表示されたコマンドをローカル環境で実行し、事前にビルドしたイメージをECRにプッシュします。

```bash
# aws ecr get-login-password ...
# docker build ...
# docker tag ...
# docker push ...
```

---

# 5. 踏み台サーバーの構築 (EC2)

EC2ダッシュボードから「インスタンスを起動」します。

- **名前**: `handson-bastion`
- **AMI**: `Amazon Linux 2023 AMI`
- **インスタンスタイプ**: `t2.micro` (無料枠)
- **キーペア**: 新規作成 or 既存のものを選択
- **ネットワーク設定**:
  - **VPC**: `handson-vpc`
  - **サブネット**: **パブリック**サブネットを選択
  - **パブリックIPの自動割り当て**: `有効化`
  - **セキュリティグループ**: `handson-bastion-sg`

---

# 6. ECS: クラスターとタスク定義

ECSダッシュボードでクラスターとタスク定義を作成します。

**1. クラスターの作成**

- **クラスター名**: `handson-cluster`
- **インフラストラクチャ**: `AWS Fargate (サーバーレス)`

**2. タスク定義の作成**

- **タスク定義ファミリー**: `handson-app-task`
- **起動タイプ**: `AWS Fargate`
- **CPU / メモリ**: `0.25 vCPU` / `0.5 GB`
- **コンテナ設定**:
  - **名前**: `handson-app-container`
  - **イメージURI**: ECRにプッシュしたイメージのURI
  - **ポートマッピング**: `8080`

---

# 6. ECS: サービスの作成

作成したクラスター内でサービスを作成します。

- **起動タイプ**: `FARGATE`
- **タスク定義**: `handson-app-task`
- **サービス名**: `handson-app-service`
- **必要なタスク**: `1`
- **ネットワーキング**:
  - **VPC**: `handson-vpc`
  - **サブネット**: **プライベート**サブネットを選択
  - **セキュリティグループ**: `handson-ecs-sg`
- **ロードバランシング**:
  - **種類**: `Application Load Balancer` (新規作成)
  - **リスナー**: `HTTP:80`
  - **ターゲットグループ**: 新規作成

---

# 7. 動作確認

**1. Webアプリケーションの確認**

- EC2 > ロードバランサー に移動。
- `handson-alb` のDNS名をコピーし、ブラウザでアクセス。
- "Hello from ECS on Fargate!" と表示されれば成功。

**2. RDSへの接続確認**

- `handson-bastion` EC2インスタンスにSSHで接続。
  ```bash
  ssh -i your-key.pem ec2-user@<BastionのパブリックIP>
  ```
- 踏み台サーバー上でMySQLクライアントを使い、RDSに接続。
  ```bash
  # 踏み台サーバー内で実行
  sudo dnf install mysql -y
  mysql -h <RDSのエンドポイント> -u admin -p
  ```

---

# 8. クリーンアップ

**重要:** 作成したリソースは課金対象です。不要になったら必ず削除してください。

1.  **ECS**: サービス削除 → クラスター削除
2.  **EC2**: 踏み台インスタンスを終了
3.  **ALB**: ロードバランサーを削除
4.  **RDS**: DBインスタンスを削除 (削除保護の無効化が必要)
5.  **ECR**: リポジトリを削除
6.  **VPC**: NAT GW削除 → IGWデタッチ → VPC削除
7.  **CloudWatch**: ロググループの削除

---
layout: center
---

## Q & A
